<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../elements/feadr-post-overview.html">
<link rel="import" href="../elements/feadr-area-input.html">
<link rel="import" href="../elements/feadr-search-tags.html">
<link rel="import" href="../feadr-app/shared-styles.html">
<!--TODO When changing the location make the list appear empty-->
<dom-module id="feadr-page-discover">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: calc(100% - 48px);
        --paper-input-container-focus-color: #544475;
      }

      #list {
        @apply (--layout-flex);
        --iron-list-items-container: {
          max-width: 800px;
          margin: 0 auto;
        };
      }

      .post {
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
      }
      .content {
        margin: 0 auto;
        max-width: 800px;
      }
      .bottomSearchBar {
        overflow: hidden;
        width: 100%;
        margin: 0 auto;
      }
      .searchBar {
        float: left;
        height: 200px;
        width: 80%;
      }
      .switchButton {
        float: left;
        width: 20%;
        margin-top: 10px;
      }
      paper-button {
        color: white;
        background-color: #544475;
      }
    </style>
    <div class="content">
      <iron-location id="ironLocation"></iron-location>
      <div class="posts">
        <iron-list id="list" items="{{posts}}" as="post" scroll-target="document">
          <template>
            <feadr-post-overview class="post"
                                 on-tap="handleTap"
                                 key$="[[post.key]]"
                                 title$="[[post.val.title]]"
                                 username$="[[post.val.username]]"
                                 location$="[[post.val.location.name]]"
                                 time$="[[post.val.time]]"
                                 points$="[[post.val.points]]"
                                 thumbnail$="[[post.val.thumbnail]]">
            </feadr-post-overview>
          </template>
        </iron-list>
      </div>
      <div class="bottomSearchBar">
        <div class="searchBar">
          <feadr-search-tags id="tagInput" tagPosts="{{tagPosts}}"></feadr-search-tags>
          <feadr-area-input id="areaInput" style="display: none;" location="{{area}}" areaselect="{{type}}" reference="{{reference}}" origin="{{origin}}"></feadr-area-input>
        </div>
        <div class="switchButton">
          <!-- Temp switch button -->
          <paper-button on-tap="changeSearchBar"><iron-icon icon="autorenew"></iron-icon></paper-button>
        </div>
      </div>
    </div>
  </template>
  <script>
      class FeadrDiscover extends Polymer.Element {
          static get is() {
              return 'feadr-page-discover';
          }

          static get properties() {
              return {
                  posts: {
                      type: Array,
                      value: [],
                      notify: true,
                  },
                  origin: {
                      type: Object,
                      value: null,
                      notify: true,
                  },
                  location: {
                      type: String,
                  },
                  areaselect: {
                      type: String,
                  },
                  currentBar: {
                      type: String,
                      value: 'tag',
                  },
                  tagPosts: {
                      type: Array,
                      observer: 'tagPostsChanged',
                      notify: true,
                  },
              };
          }

          static get observers() {
              return [
                  '_changedType(type, area, reference)',
              ];
          }

          handleTap(e) {
              const key = e.target.getAttribute('key');
              this.$.ironLocation.set('path', '/post/'+key);
          }
          _changedType(type, area) {
              console.log(type +' and '+ area);
              if(type.length > 0 && area.length > 0 ) {
                  if(this.origin.location === false) {
                      let array = area.split(',');
                      // console.log(array);
                      switch (array.length) {
                          case 1:
                              // Country
                              console.log('Reached Case 1');
                              type = 'country';
                              area = array[0];
                              break;
                          case 2:
                              // Province
                              console.log('Reached Case 2');
                              type = 'administrative_area_level_1';
                              area = array[0];
                              break;
                          case 3:
                              // Route
                              console.log('Reached Case 3');
                              type = 'route';
                              area = array[0];
                              break;
                          case 4:
                              // postal_code
                              type = 'route';
                              console.log('Reached Case 4');
                              area = array[0];
                              break;
                          case 5:
                              console.log('Reached Case 5');
                              area = array[0];
                              break;
                      }
                  }
                      console.log('location/'+type+'/'+area+'/posts/');
//                 eslint-disable-next-line
                database.ref('location/'+type+'/'+area+'/posts/').on('child_added', (snapshot) => {
                      console.log(snapshot.val());
                      this.push('posts', {
                          key: snapshot.key,
                          val: snapshot.val(),
                      });
                  });
                  console.log(this.posts);
              }
          }
          ready() {
              super.ready();
          }
          changeSearchBar() {
              var locationBar = this.$.areaInput;
              var tagsBar = this.$.tagInput;

              if(this.currentBar === 'tag') {
                locationBar.setAttribute('style', 'display: visible');
                tagsBar.setAttribute('style', 'display: none');
                this.currentBar = 'location';
              } else if(this.currentBar === 'location') {
                locationBar.setAttribute('style', 'display: none');
                tagsBar.setAttribute('style', 'display: visible');
                this.currentBar = 'tag';
              }
          }
      }
      window.customElements.define(FeadrDiscover.is, FeadrDiscover);
  </script>
</dom-module>
