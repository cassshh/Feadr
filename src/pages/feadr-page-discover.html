<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../elements/feadr-post-overview.html">
<link rel="import" href="../elements/feadr-area-input.html">
<link rel="import" href="../feadr-app/shared-styles.html">
<!--TODO When changing the location make the list appear empty-->
<dom-module id="feadr-page-discover">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: calc(100% - 48px);
      }

      #list {
        @apply (--layout-flex);
        --iron-list-items-container: {
          max-width: 800px;
          margin: 0 auto;
        };
      }

      .post {
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
      }
    </style>
    <feadr-area-input location="{{area}}" areaselect="{{type}}"></feadr-area-input>
    <iron-location id="ironLocation"></iron-location>
    <iron-list id="list" items="{{posts}}" as="post" scroll-target="document">
      <template>
        <feadr-post-overview class="post"
                             on-tap="handleTap"
                             key$="[[post.key]]"
                             title$="[[post.val.title]]"
                             username$="[[post.val.username]]"
                             location$="[[post.val.location.name]]"
                             time$="[[post.val.time]]"
                             points$="[[post.val.points]]"
                             thumbnail$="[[post.val.thumbnail]]">
        </feadr-post-overview>
      </template>
    </iron-list>
  </template>
  <script>
      class FeadrDiscover extends Polymer.Element {
          static get is() {
              return 'feadr-page-discover';
          }

          static get properties() {
              return {
                  posts: {
                      type: Array,
                      value: [],
                      notify: true,
                  },
                  location: {
                      type: String,
                  },
                  areaselect: {
                      type: String,
                  },
              };
          }

          static get observers() {
              return [
                  '_changedType(type, area)',
              ];
          }

          handleTap(e) {
              const key = e.target.getAttribute('key');
              this.$.ironLocation.set('path', '/post/'+key);
          }
          _changedType(type, area) {
              if(type.length > 0 && area.length > 0 ) {
//                 splice the array so there is room for new content
//                  console.log('Array will be spliced');
                  this.splice('posts', 0, this.posts.length);
//                  console.log('the array posts equals: ' + this.posts.length);
//                 eslint-disable-next-line
                database.ref('location/'+type+'/'+area+'/posts/').on('child_added', (snapshot) => {
                      console.log(snapshot.val());
                      this.push('posts', {
                          key: snapshot.key,
                          val: snapshot.val(),
                      });
                  });
                  console.log(this.posts);
              }
          }
          ready() {
              super.ready();
          }
      }
      window.customElements.define(FeadrDiscover.is, FeadrDiscover);
  </script>
</dom-module>
