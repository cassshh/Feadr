<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-location/iron-location.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../elements/feadr-post-overview.html">
<link rel="import" href="../elements/feadr-area-input.html">
<link rel="import" href="../elements/feadr-search-tags.html">
<link rel="import" href="../feadr-app/shared-styles.html">
<!--TODO When changing the location make the list appear empty-->
<dom-module id="feadr-page-discover">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: calc(100% - 48px);
        --paper-input-container-focus-color: #544475;
      }

      #list {
        @apply (--layout-flex);
        --iron-list-items-container: {
          max-width: 800px;
          margin: 0 auto;
        };
      }

      .post {
        border-bottom: 1px solid rgba(0, 0, 0, 0.12);
      }
      .content {
        margin: 0 auto;
        max-width: 800px;
      }
      .topSearchBar {
        overflow: hidden;
        max-width: 800px;
        margin: 0 auto;
        height: 100px;
      }
      .searchBar {
        float: left;
        width: 70%;
      }
      .switchButton {
        float: right;
        margin-top: 10px;
      }
      paper-button {
        width: 35px;
        color: white;
        background-color: #544475;
      }
    </style>
      <div class="topSearchBar">
        <div class="searchBar">
          <feadr-search-tags id="tagInput" tag="{{tag}}"></feadr-search-tags>
          <feadr-area-input id="areaInput" style="display: none;" location="{{area}}" areaselect="{{type}}"></feadr-area-input>
        </div>
        <div class="switchButton">
          <!-- Temp switch button -->
          <paper-button on-tap="changeSearchBar"><iron-icon icon="autorenew"></iron-icon></paper-button>
        </div>
      </div>
      <div class="content">
        <iron-location id="ironLocation"></iron-location>
        <div class="posts">
          <iron-list id="list" items="{{posts}}" as="post" scroll-target="document">
            <template>
              <feadr-post-overview class="post"
                                   on-tap="handleTap"
                                   key$="[[post.key]]"
                                   title$="[[post.val.title]]"
                                   username$="[[post.val.username]]"
                                   location$="[[post.val.location.name]]"
                                   time$="[[post.val.time]]"
                                   points$="[[post.val.points]]"
                                   thumbnail$="[[post.val.thumbnail]]">
              </feadr-post-overview>
            </template>
          </iron-list>
        </div>
    </div>
  </template>
  <script>
      class FeadrDiscover extends Polymer.Element {
          static get is() {
              return 'feadr-page-discover';
          }

          static get properties() {
              return {
                  posts: {
                      type: Array,
                      value: [],
                      notify: true,
                  },
                  location: {
                      type: String,
                  },
                  areaselect: {
                      type: String,
                  },
                  currentBar: {
                      type: String,
                      value: 'tag',
                  },
                  tag: {
                      type: String,
                      observer: 'tagChanged',
                  },
              };
          }

          static get observers() {
              return [
                  '_changedType(type, area)',
              ];
          }

          handleTap(e) {
              const key = e.target.getAttribute('key');
              this.$.ironLocation.set('path', '/post/'+key);
          }
          _changedType(type, area) {
              if(type.length > 0 && area.length > 0 ) {
//                 splice the array so there is room for new content
//                  console.log('Array will be spliced');
                  this.splice('posts', 0, this.posts.length);
//                  console.log('the array posts equals: ' + this.posts.length);
//                 eslint-disable-next-line
                database.ref('location/'+type+'/'+area+'/posts/').on('child_added', (snapshot) => {
                      console.log(snapshot.val());
                      this.push('posts', {
                          key: snapshot.key,
                          val: snapshot.val(),
                      });
                  });
                  console.log(this.posts);
              }
          }
          ready() {
              super.ready();
          }
          changeSearchBar() {
              var locationBar = this.$.areaInput;
              var tagsBar = this.$.tagInput;

              if(this.currentBar === 'tag') {
                locationBar.setAttribute('style', 'display: visible');
                tagsBar.setAttribute('style', 'display: none');
                this.currentBar = 'location';
              } else if(this.currentBar === 'location') {
                locationBar.setAttribute('style', 'display: none');
                tagsBar.setAttribute('style', 'display: visible');
                this.currentBar = 'tag';
              }
          }
          tagChanged() {
              // Get posts based on tag
              //eslint-disable-next-line
              database.ref('tags/' + this.tag + '/posts').once('value', (snapshot) => {
                  this.posts = [];
                  snapshot.forEach((childSnapshot) => {
                      database.ref('overview/' + childSnapshot.key).on('value', (post) => {
                          this.push('posts', {
                              key: post.key,
                              val: post.val(),
                          });
                       });
                   });
               });
          }

      }
      window.customElements.define(FeadrDiscover.is, FeadrDiscover);
  </script>
</dom-module>
